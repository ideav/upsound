# Базовые правила разработки

## UI

Все рабочие места оформляются в виде шаблонов в html-файлах и доступны пользователю по адресу:

```
https://{host}/{db}/{имя шаблона без .html}
```

Содержимое шаблона в папке `templates` обрабатывается и вставляется в файл `main.html` вместо конструкции `<!-- File: a -->`.

### Точки вставки в шаблонах

В файлах шаблонов используются точки вставки вида `{value}`, которые понимает шаблонизатор, поэтому все конструкции вида:

```javascript
`${name}=${encodeURIComponent(JSON.stringify(value))}; path=/`
```

надо дополнять пробелами, например: `${name}` => `${ name }`, чтобы шаблонизатор не путал `name` с точкой вставки.

### Структура шаблонов

Поэтому из шаблона рабочего места надо убирать всё, что уже есть в `main.html`, и оставить только специфичные для него вещи.

Скрипты и стили выносятся в отдельные файлы по пути:

```
https://{host}/download/{db}/{js или css}
```

При изменении скриптов и стилей надо добавлять к пути их подключения номер PR, чтобы брался актуальный файл, например:

```html
<script src="/download/{_global_.z}/constructor.js?{pull request id}"></script>
```

### Авторизация

Если пользователь – `guest`, то перенаправить его в рабочее место логина:

```
https://{host}/{db}/login
```

## Команды API

Бэкенд полностью сделан в конструкторе Интеграм, к нему можно обращаться по API, запрашивая информацию по предконфигурированным запросам и сохраняя её командами DML.

### Структура API запросов

Все запросы к системе по API выполняются по такому адресу, который необходимо параметризовать:

```
https://{host}/{db}/{cmd}/{id}
```

#### Параметры:

- **`{host}`** - адрес текущего хоста, значение далее в примерах: `integram.io`
- **`{db}`** - имя текущей базы данных, с которой мы работаем. Оно хранится в переменной `db` javascript, которая уже проинициализирована на странице и её можно использовать
- **`{cmd}`** - название рабочего места или команда DML
- **`{id}`** - необязательный параметр, ID таблицы или записи в ней

### XSRF токен

Для запросов на сохранение данных использовать токен XSRF, передаваемый как POST-параметр:

```
_xsrf={значение переменной xsrf}
```

Переменная `xsrf` проинициализирована на странице и её можно использовать.

### Создание записи

В ответ на команду `_m_new` (создать запись) будет получен JSON с ID созданной записи в ключе `obj`.
