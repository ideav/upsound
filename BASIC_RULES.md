# Базовые правила разработки

## UI

Все рабочие места оформляются в виде шаблонов в html-файлах и доступны пользователю по адресу:

```
https://{host}/{db}/{имя шаблона без .html}
```

Содержимое шаблона в папке `templates` обрабатывается и вставляется в файл `main.html` вместо конструкции `<!-- File: a -->`.

### Точки вставки в шаблонах

В файлах шаблонов используются точки вставки вида `{value}`, которые понимает шаблонизатор, поэтому все конструкции вида:

```javascript
`${name}=${encodeURIComponent(JSON.stringify(value))}; path=/`
```

надо дополнять пробелами, например: `${name}` => `${ name }`, чтобы шаблонизатор не путал `name` с точкой вставки.

### Структура шаблонов

Поэтому из шаблона рабочего места надо убирать всё, что уже есть в `main.html`, и оставить только специфичные для него вещи.

Скрипты и стили выносятся в отдельные файлы по пути:

```
https://{host}/download/{db}/{js или css}
```

### Версионирование скриптов и стилей

При изменении скриптов и стилей обязательно добавляйте номер PR к URL, чтобы браузер загрузил актуальную версию файла, а не использовал кэшированную:

**Зачем это нужно:**
- Браузер кэширует CSS и JS файлы
- Без параметра версии пользователи могут видеть старую версию после обновления
- Изменение параметра заставляет браузер загрузить новый файл

**Как использовать:**

```html
<!-- Номер PR #23 -->
<script src="/download/{_global_.z}/constructor.js?23"></script>
<link rel="stylesheet" href="/download/{_global_.z}/styles.css?23">
```

**Правило:** При каждом изменении файла используйте номер текущего PR.

### Авторизация

Если пользователь – `guest`, то перенаправить его в рабочее место логина:

```
https://{host}/{db}/login
```

## Команды API

Бэкенд полностью сделан в конструкторе Интеграм, к нему можно обращаться по API, запрашивая информацию по предконфигурированным запросам и сохраняя её командами DML.

### Структура API запросов

Все запросы к системе по API выполняются по такому адресу, который необходимо параметризовать:

```
https://{host}/{db}/{cmd}/{id}
```

#### Параметры:

- **`{host}`** - адрес текущего хоста, значение далее в примерах: `integram.io`
- **`{db}`** - имя текущей базы данных, с которой мы работаем. Доступно через глобальную переменную **`window.db`** (уже проинициализирована в `main.html`)
- **`{cmd}`** - название рабочего места или команда DML
- **`{id}`** - необязательный параметр, ID таблицы или записи в ней

**Важно:** Используйте `window.db`, а НЕ `window._global_.z` (устаревший способ).

### Результат в формате JSON

Чтобы API вернул результат в формате JSON в запрос должен быть добавлен параметр `JSON_KV` или `JSON` для команд `report/` и `JSON` для всех остальных команд.

`JSON_KV` возвращает отчет в формате key:value, например:

```
[
	{   "Запрос": "Мои  счета в оплате",
        "ЗапросID": "3231",
        "Описание": "",
        "Формат отчета": "smartq",
        "приоритет": "X"
    },
    {   "Запрос": "Мои лиды",
        "ЗапросID": "3003",
        "Описание": "",
        "Формат отчета": "smartq",
        "приоритет": "X"
    },
    {   "Запрос": "Мои сделки в ожидании",
        "ЗапросID": "3139",
        "Описание": "",
        "Формат отчета": "smartq",
        "приоритет": "X"
    }
]
```

`JSON` возвращает отчет с информацией о его колонках, например:
```
{
    "columns": [
        {
            "id": "300",
            "type": "22",
            "format": "SHORT",
            "name": "Запрос",
            "granted": 1
        },
        {
            "id": "302",
            "type": "22",
            "format": "NUMBER",
            "name": "ЗапросID",
            "granted": 1
        },
        {
            "id": "311",
            "type": "298",
            "format": "MEMO",
            "name": "Описание",
            "granted": 1
        },
        {
            "id": "3074",
            "type": "3068",
            "format": "SHORT",
            "name": "Формат отчета",
            "granted": 1,
            "ref": 1
        },
        {
            "id": "3269",
            "type": "3230",
            "format": "BOOLEAN",
            "name": "приоритет",
            "granted": 1
        }
    ],
    "data": [
        [
            "Мои  счета в оплате",
            "Мои лиды",
            "Мои сделки в ожидании",
            "Мои ближайшие продления",
            "Мои сделки - ВСЕ",
            "Мои сделки в работе"
        ],
        [
            "3231",
            "3003",
            "3139",
            "3278",
            "3188",
            "3042"
        ],
        [
            "",
            "",
            "",
            "",
            "",
            ""
        ],
        [
            "smartq",
            "smartq",
            "smartq",
            "smartq",
            "smartq",
            "smartq"
        ],
        [
            "X",
            "X",
            "X",
            "",
            "",
            ""
        ]
    ]
}
```

### XSRF токен

Для запросов на сохранение данных использовать токен XSRF, передаваемый как POST-параметр:

```
_xsrf={значение переменной xsrf}
```

Переменная `xsrf` проинициализирована на странице и её можно использовать.

### Создание и изменение записи

Команда `_m_new` должна иметь параметр `up` - то ID родителя. Если в задании не указано иное, то передавать up=1, то есть создаваемая запись не подчинена никому и находится в корне.

В ответ на команду `_m_new` (создать запись) будет получен JSON с ID созданной записи в ключе `obj`.

Если при POST-запросе получен JSON с ключом error - вывести текст error как ошибку.

Если при редактировании записи какое-то поле было очищено, то это поле надо передавать при сохранении с пустым значением, например: `_m_save/1312?JSON&t304`. 
