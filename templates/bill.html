<div class="p-3">
<h3>–ë–∏–ª–ª–∏–Ω–≥ <span id="artistName"></span></h3>
<p class="rebill-all" style="display:none"><a onclick="location.href=location.href+'&recalcAll=1'" class="btn btn-sm btn-outline-secondary">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å—ë</a></p>
<h5>
    –ü—Ä–æ–≤–µ—Ä–∫–∏: 
    &nbsp;<a href="/{_global_.z}/bill" id="reresh" style="display:none"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M25 5.99763V11.9976M25 11.9976H19M25 11.9976L20.36 7.63763C19.2853 6.56235 17.9556 5.77684 16.4952 5.35441C15.0348 4.93198 13.4911 4.88639 12.0083 5.22189C10.5255 5.5574 9.1518 6.26307 8.01547 7.27305C6.87913 8.28304 6.01717 9.56442 5.51 10.9976M3 21.9976V15.9976M3 15.9976H9M3 15.9976L7.64 20.3576C8.71475 21.4329 10.0444 22.2184 11.5048 22.6409C12.9652 23.0633 14.5089 23.1089 15.9917 22.7734C17.4745 22.4379 18.8482 21.7322 19.9845 20.7222C21.1209 19.7122 21.9828 18.4308 22.49 16.9976" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
</h5>
<p><b>–ü—Ä–∞–≤–∫–∏</b> <span id="fixes"><img src="/i/ajax.gif"></span></p>
<p><b>–ù–æ–≤—ã—Ö –∞—Ä—Ç–∏—Å—Ç–æ–≤</b> <span id="artists"><img src="/i/ajax.gif"></span></p>
<p><b>–ù–æ–≤—ã—Ö —Ç—Ä–µ–∫–æ–≤</b> <span id="tracks"><img src="/i/ajax.gif"></span></p>
<p><b>–î–æ–ª–µ–π –∞—Ä—Ç–∏—Å—Ç–æ–≤</b> <span id="shares"><img src="/i/ajax.gif"></span></p>
<table class="table table-bordered w-auto bill" style="display:none">
<tr style="background-color:#f9f9f9;">
<th>–î–∞—Ç–∞<th>–°—Ç—Ä–∏–º—ã<th>–ë–∏–ª–ª–∏–Ω–≥<th>–†–∞—Å—á—ë—Ç
</tr>
<tbody class="bill-table">
    <tr class="bill-line bill-line-new">
        <td class="stream-date"><img src="/i/ajax.gif">
        <td class="qty" align="right">
        <td class="fact" align="right">
        <td class="rebill" align="right">
    </tr>
</tbody>
</table>
<p><a onclick="i=-10000;fetchStats();$(this).remove()" class="btn btn-sm btn-outline-secondary bill-all" style="display:none">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ</a></p>
</div>
<script>
const ajaxWait='<img src="/i/ajax.gif">'
    ,rowTemplate=$('.bill-table').html();
var byArtist='',i=0,dates=[];
function checkArtists(json){
    var count=0;
    for(var i in json)
        count++;
    if(count===0)
        $('#artists').html('- OK');
    else
        $('#artists').html('<br />–ê—Ä—Ç–∏—Å—Ç–æ–≤ –±–µ–∑ —Å—Ç–∞–≤–∫–∏: '+count+' <a class="issues" target="bill" href="/{_global_.z}/report/57608552">–ò—Å–ø—Ä–∞–≤–∏—Ç—å</a>');
    newApi('POST','report/63362069?JSON_KV'+byArtist,'checkTracks');
}
function checkTracks(json){
    var count=0;
    for(var i in json)
        count++;
    if(count===0)
        $('#tracks').html('- OK');
    else
        $('#tracks').html('<br />–¢—Ä–µ–∫–æ–≤ –±–µ–∑ —Å—Ç–∞–≤–∫–∏: '+count+' <a class="issues" target="bill" href="/{_global_.z}/report/63362069">–ò—Å–ø—Ä–∞–≤–∏—Ç—å</a>');
    newApi('POST','report/61162530?JSON_KV'+byArtist,'checkShares');2
}
function checkShares(json){
    var count=0;
    for(var i in json)
        count++;
    if(count===0)
        $('#shares').html('- OK');
    else
        $('#shares').html('<br />–¢—Ä–µ–∫–æ–≤ –±–µ–∑ –¥–æ–ª–µ–π: '+count+' <a class="issues" target="bill" href="/{_global_.z}/report/61162530">–ò—Å–ø—Ä–∞–≤–∏—Ç—å</a>');
    if($('.issues').length===0){
        $('.bill').show();
        if(byArtist==='')
            newApi('POST','report/70757850?JSON_KV','billDates');
        else
            newApi('POST','report/74694032?JSON_KV'+byArtist,'billDates');
    }
    $('.reresh').show();
}
function flipDate(d){
    return d.substr(-4)+d.substr(3,2)+d.substr(0,2);
}
var billSess=0,artList;
function rebill(){
    const vars={el:$('.bill-line-new').find('.rebill')[0],date:$('.bill-line-new').find('.stream-date').html()};
    if(byArtist==='')
        billArtists();
        //oneBill(undefined,vars);
    else
        newApi('POST','report/74694050?JSON_KV&TIME=0&date='+$('.bill-line-new').find('.stream-date').html()
                                                            +byArtist,'rebillDone','confirmed=1',vars);
}
// Cookie helpers
function setCookie(name, value) {
    document.cookie = `${ name }=${ encodeURIComponent(JSON.stringify(value)) }; path=/`;
}

function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) {
        try {
            return JSON.parse(decodeURIComponent(match[2]));
        } catch(e) {
            return null;
        }
    }
    return null;
}

function deleteCookie(name) {
    document.cookie = `${ name }=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
async function processArtists(artList, maxConcurrent = 3) {
  const d=$('.bill-line-new').find('.stream-date').html();
  const baseUrl = 'https://upsound.ideav.online/upsound/report/74694050?JSON_KV&confirmed=1&TIME=0&date='+d+'&FR_byArtist=';
  const progressElement = $('.rebill')[0];
  const logElement = document.getElementById('log');

  let completed = 0;
  let hasError = false;
  const total = artList.length;

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑ cookie
  const savedProgress = getCookie('billProgress');
  if (savedProgress && savedProgress.date === d) {
      completed = savedProgress.completed || 0;
  }

  function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML = `[${ timestamp }] ${ message }<br>`+logElement.innerHTML;
      logElement.scrollTop = logElement.scrollHeight;
  }

  function updateProgress() {
      const percent = Math.floor((completed / total) * 100);
      progressElement.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${ percent }% (${ completed }/${ total })`;

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ cookie
      setCookie('billProgress', {
          date: d,
          completed: completed,
          total: total
      });
  }

  async function processArtist(artist, isRetry = false) {
      if (hasError) return null;

      const url = baseUrl + artist.ArtistID + '&FR_ISRCID=' + artist.ISRCID;

      try {
          log(`–ó–∞–ø—Ä–æ—Å –¥–ª—è ${ artist.Artist } (ID: ${ artist.ArtistID }, ISRCID:  ${ artist.ISRCID })...`);
          const formData = new URLSearchParams();
          formData.append('_xsrf', xsrf);

          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded'
              },
              body: formData.toString()
          });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${ response.status }`);
          }

          const text = await response.text();

          let data;
          try {
              data = JSON.parse(text);
          } catch (e) {
              throw new Error(`–û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON –¥–ª—è –∞—Ä—Ç–∏—Å—Ç–∞ ${ artist.Artist } (ID: ${ artist.ArtistID })`);
          }

          completed++;
          updateProgress();
          log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${ artist.Artist }, ISRCID:  ${ artist.ISRCID }`);

          return { success: true, artist, data };

      } catch (error) {
          // –î–æ–±–∞–≤–ª—è–µ–º URL –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –æ–± –æ—à–∏–±–∫–µ
          const errorWithUrl = `${ error.message }\nURL: ${ url }`;

          // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
          if (!isRetry) {
              log(`‚ö†Ô∏è –û—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥: ${ errorWithUrl }`);
              await new Promise(resolve => setTimeout(resolve, 5000));
              return await processArtist(artist, true);
          }

          hasError = true;
          progressElement.textContent = `‚ùå –û—à–∏–±–∫–∞: ${ error.message }`;
          progressElement.style.color = 'red';
          log(`‚ùå –û–®–ò–ë–ö–ê: ${ errorWithUrl }`);
          throw new Error(errorWithUrl);
      }
  }

  async function processWithLimit(items, limit) {
      const results = [];
      const executing = [];

      // –ù–∞—á–∏–Ω–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
      const startIndex = savedProgress && savedProgress.date === d ? completed : 0;

      for (let idx = startIndex; idx < items.length; idx++) {
          if (hasError) break;

          const item = items[idx];
          const promise = processArtist(item).then(result => {
              executing.splice(executing.indexOf(promise), 1);
              return result;
          });

          results.push(promise);
          executing.push(promise);

          if (executing.length >= limit) {
              await Promise.race(executing);
          }
      }

      return Promise.all(results);
  }

  updateProgress();
  progressElement.style.color = 'black';
  log(`üöÄ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${ total } –∞—Ä—Ç–∏—Å—Ç–æ–≤ (–º–∞–∫—Å. ${ maxConcurrent } –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö)`);

  try {
      const results = await processWithLimit(artList, maxConcurrent);

      if (!hasError) {
          progressElement.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ: 100% (${ total }/${ total })`;
          progressElement.style.color = 'green';
          log(`üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`);

          // –£–¥–∞–ª—è–µ–º cookie –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
          deleteCookie('billProgress');
      }

      return results.filter(r => r !== null);

  } catch (error) {
      log(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${ error.message }`);
      throw error;
  }
}

function billArtists(){
    newApi('POST','report/79265113?JSON_KV','processArtists');
}
function oneArtistBill(json,vars){
    if(!json&&billSess>0)
        return $(vars.el).html('Error');
}
function oneBill(json,vars){
    if(!json&&billSess>0)
        return $(vars.el).html('Error');
    const d=$('.bill-line-new').find('.stream-date').html();
    if(billSess<=10){
        $(vars.el).html(' '+billSess+'0% '+ajaxWait);
        newApi('POST','report/61162329?JSON_KV&TIME=0&date='+d+'&FR_batch=%25'+(billSess++),'oneBill','confirmed=1',{el:vars.el,date:d});
    }
    else
        rebillDone(json,vars);
}
function rebillDone(json,vars){
    $(vars.el).html(ajaxWait);
    fetchStats();
    if(byArtist==='')
        newApi('POST','report/7425710?JSON_KV&FR_date='+vars.date,'rebillRecalc','',vars.el);
    else
        newApi('POST','report/74694096?JSON_KV&FR_date='+vars.date+byArtist,'rebillRecalc','',vars.el);
}
function rebillRecalc(json,el){
    $(el).html(json[0].Quantity);
}
function fetchStats(){
    const bill=dates.shift();
    if(bill&&bill.date){
        $('.bill-line-new').removeClass('bill-line-new');
        $('.bill-table').append(rowTemplate);
        $('.bill-line-new').find('.stream-date').html(bill.date);
        $('.bill-line-new').find('.qty').html(ajaxWait);
        if(byArtist==='')
            newApi('POST','report/63350550?JSON_KV&FR_Stream='+bill.date,'fetchStatsDone');
        else
            newApi('POST','report/74694086?JSON_KV&FR_Stream='+bill.date+byArtist,'fetchStatsDone');
    }
}
function fetchStatsDone(json){
    $('.bill-line-new').find('.fact').html(ajaxWait);
    $('.bill-line-new').find('.qty').html(json[0].Quantity);
    if(byArtist==='')
        newApi('GET','report/7425710?JSON_KV&FR_date='+json[0].Stream,'fetchBills');
    else
        newApi('GET','report/74694096?JSON_KV&FR_date='+json[0].Stream+byArtist,'fetchBills');
}
function fetchBills(json){
    if(json[0]){
        $('.bill-line-new').find('.fact').html(json[0].Quantity);
        if(json[0].Quantity!==$('.bill-line-new').find('.qty').html()||search.recalcAll)
            $('.bill-line-new').find('.fact').addClass('text-danger font-weight-bold');
        else if(i++>7&&!search.recalcAll)
            return $('.bill-all').show();
        else
            return fetchStats();
    }
    else
        $('.bill-line-new').find('.fact').html('‚Äî');
    rebill();
}
function fixAlita(json){
    $('#fixes').html('–ü—Ä–∞–≤–∫–∞ ALITA - Ok');
}
function billDates(json){
    for(var i in json)
        dates[i]={date:json[i].Date};
    $('.bill-table').html('');
    fetchStats();
}
function getArtist(json){
    $('.rebill-all').show();
    $('#artistName').html(json.object[0].val);
}
if(search.byArtist){
    newApi('GET','object/10869?JSON&F_10869=@'+search.byArtist,'getArtist');
    byArtist='&FR_byArtist='+search.byArtist;
}
newApi('POST','report/74673702?JSON_KV','fixAlita');
newApi('POST','report/57608552?JSON_KV'+byArtist,'checkArtists');
</script>
<div id="log"></div>
